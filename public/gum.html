<!doctype html>
<html>
<head>
	<title>getUserMedia to jpeg sample</title>
	<script type="text/javascript" src="./javascripts/jquery-1.9.1.min.js"></script>
	<style type="text/css">
	/* canvas { display: none;} /* 画像変換用の不可視のcanvas */
	</style>
</head>
<body>
	<section>
		<h1>video</h1>
		<video></video>
	</section>
	<section>
		<h1>captured jpeg</h1>
		<canvas></canvas>
		<textarea cols="180" rows="10" heighreadonly></textarea><br>
		<img><br>
	</section>

<script type="text/javascript">
(function(){
	var $v_ = $("video")
		, $c_ = $("canvas")
		, $i_ = $("img")
		, ctx_ = $c_[0].getContext('2d')
		, $t_ = $("textarea")

	// Streaming開始
	navigator.webkitGetUserMedia({video: true, audio: false}, function(stream){
		var url = window.webkitURL.createObjectURL(stream);
		$v_[0].src = url;
		$v_[0].play();

	})


	var detect_edge = function(img, width, height){
	    var data_quant = [];
	    for(var i = 0; i < img.data.length; i+=4){
	        var r = img.data[i]&0xFF;
	        var g = img.data[i+1]&0xFF;
	        var b = img.data[i+2]&0xFF;
	        var gray = (r+g+b)/3;
	        data_quant.push(gray & 0xC0);
	    }

	    var img_edge = ctx_.createImageData(width, height);
	    for(var y = 1; y < height-1; y++){
	        for(var x = 1; x < width-1; x++){
	            var i = y*width + x;
	            var around = (data_quant[i-width]+data_quant[i-1]+data_quant[i+1]+data_quant[i+width])/4;

	            if(around < data_quant[i]) var c = 0;
	            else var c = 255;
	            img_edge.data[i*4] = c;
	            img_edge.data[i*4+1] = c;
	            img_edge.data[i*4+2] = c;
	            img_edge.data[i*4+3] = 255;
	        }
	    }
	    return img_edge;
	};

	// Videoの再生が始まったら、JPEGの取得を開始する。
	$v_.on("playing", function(){
		// canvas(不可視)のサイズをvideoサイズに変更	
		var w = $(this)[0].videoWidth;
		var h = $(this)[0].videoHeight;

		var c = 0;

		$c_[0].width = w;
		$c_[0].height = h;

		// 1秒おきに画像に変更
		// ref http://www.slideshare.net/masayukimaekawa/java-script-14727253
		setInterval(function(){
			// 映像フレームをcanvasに書き出す
			ctx_.drawImage($(this)[0], 0, 0)


			var imgData = ctx_.getImageData(0, 0, w, h)

			var dotList = imgData.data;
			// var trans = ctx_.createImageData(w, h)
			var edge = detect_edge(imgData, w, h)

			for(var i = 0, l = dotList.length; i < l; i+=4){
				var r = dotList[i]
					, g = dotList[i+1]
					, b = dotList[i+2]
					, gray = (r + g + b) / 3;
				var d = 86;

				if(r > 255) r = 255;
				if(g > 255) g = 255;
				if(b > 255) b = 255;

				if(gray > 57) {
					gray = gray * 2.3;
					if(gray > 255) gray = 255;
				}
				var gra = parseInt(gray / d) * d;

				// 白色化
				gra = gra === 172 ? 255  : gra;

				// ドット化
				if( gra === 86 ) {
					var dx = (i % (w * 4)) / 4;
					var dy = parseInt(i / (w * 4));
					var dx_ = dx % 6;
					var dy_ = dy % 6;

					if(dy_ === 0 || dy_ === 1) {
						gra = (dx_ === 0 || dx_ === 1) ? gra = 0 : gra = 255;
					} else if(dy_ === 3 || dy_ === 4){
						gra = (dx_ === 0 || dx_ === 1) ? gra = 255 : gra = 0;
					}
					if(dx_ === 2 || dy_ === 2 || dx_ === 5 || dy_ === 5) gra = 255;
				};
				imgData.data[i] = edge.data[i] !== 0 ? gra : edge.data[i];
				imgData.data[i + 1] = edge.data[i + 1] !== 0 ? gra : edge.data[i + 1];
				imgData.data[i + 2] = edge.data[i + 2] !== 0 ? gra : edge.data[i + 2];
				imgData.data[i + 3] = edge.data[i] !== 0 ? imgData.data[i + 3] : edge.data[i + 3];
			}
//			ctx_.putImageData(imgData, 0, 0)



			ctx_.putImageData(imgData, 0, 0)

			// canvas内の画像を JPEG のデータURLに変換する	
			// var dataURL = $c_[0].toDataURL('image/jpeg')

			// // img出力および文字列出力
			// $i_.attr("src", dataURL)
			// $t_.text(dataURL)
		}.bind(this), 100)
	})
}())
</script>
</body>
</html>